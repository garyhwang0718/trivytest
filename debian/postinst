#!/bin/sh
# postinst script for qundr-sec-ops
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package


CONTROL_SH="control.sh"
NDR_PATH="/.data/qne-qundr"
IMAGE_PATH=${NDR_PATH}/sec-ops/doc/qinfluxdbkapacitor-image
SCRIPT_PATH=${NDR_PATH}/sec-ops/scripts

case "$1" in
    configure)
        if [ ! -f /build_firmware ]; then
            result=$(/bin/ip ro | /bin/grep docker0 | /usr/bin/awk -F ' ' '{print $1}' || true)
            if [ x"$result" = x"" ]; then
                echo "qundr-sec-ops: postinstall : restart containerd and docker service"
                retry=0
                while true
                do
                    systemctl stop containerd || true
                    systemctl start docker 2>/dev/null || true
                    check_result=$(ps aux | grep '[/]usr/bin/dockerd' || true)
                    if [ x"${check_result}" != x"" ]; then
                        echo "qundr-sec-ops: postinstall : docker service is ready"
                        break
                    elif [ $retry -gt 6 ]; then
                        echo "qundr-sec-ops: postinstall : docker service is something wrong."
                        exit 1
                    else
                        sleep 12
                        retry=$(($retry+1))
                    fi
                 done
            elif [ x"$result" != x"10.0.5.0/25" ]; then
                echo "qundr-sec-ops: postinstall : restart docker service"
                systemctl stop docker || true
                systemctl start docker || true
            fi
            if [ -d "$SCRIPT_PATH" ] && [ -f "$SCRIPT_PATH/$CONTROL_SH" ]; then
                `"$SCRIPT_PATH/$CONTROL_SH" load_image || true`
                if [ "x$?" = "x0" ]; then
                    echo "load qinfluxdbkapacitor image successfully"
                    "$SCRIPT_PATH/$CONTROL_SH" ver_cmp $2
                else
                    echo "load qinfluxdbkapacitor-image failure"
                    exit 1
                fi
            fi
        fi
    ;;

    abort-upgrade|abort-remove|abort-deconfigure)
    ;;

    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
    ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
